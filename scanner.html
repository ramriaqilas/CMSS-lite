<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Scanner</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <!-- Library pemindai (stabil di banyak device) -->
  <script defer src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
  <script defer src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    html,body{height:100%;margin:0;background:#000}
    #reader{width:100vw;height:100vh}
    /* kotak fokus agar user tahu area scan */
    .scan-region-highlight{border:2px solid rgba(255,255,255,.8)!important;border-radius:12px!important}
    .qr-scanner-camera-view{object-fit:cover!important}
    #msg{position:fixed;left:0;right:0;bottom:0;padding:10px 12px;background:rgba(0,0,0,.6);color:#fff;font:14px/1.4 system-ui,Arial}
  </style>
</head>
<body>
  <div id="reader"></div>
  <div id="msg">Arahkan kode ke kotak. Kamera belakang aktifâ€¦</div>

<script>
(function(){
  const tg = window.Telegram?.WebApp; try{tg?.expand(); tg?.ready();}catch(e){}
  const msg = document.getElementById('msg');
  const setMsg = (t)=> msg.textContent = t;

  function finish(text){
    try { tg?.HapticFeedback?.impactOccurred?.('light'); } catch(e){}
    try { tg?.sendData(JSON.stringify({ code: (text||'').trim() })); } catch(e){}
    setTimeout(()=>{ try{ tg?.close(); }catch(_){ window.close(); } }, 200);
  }

  function errBox(e){
    setMsg('Gagal membuka/memakai kamera: ' + (e?.name || e));
    try { tg?.sendData(JSON.stringify({__debug:true, error: e?.name || String(e)})); } catch(_){}
  }

  async function start(){
    // Format yang didukung: QR + barcode umum (Code128/39, EAN, UPC)
    const formats = [
      Html5QrcodeSupportedFormats.QR_CODE,
      Html5QrcodeSupportedFormats.CODE_128,
      Html5QrcodeSupportedFormats.CODE_39,
      Html5QrcodeSupportedFormats.EAN_13,
      Html5QrcodeSupportedFormats.EAN_8,
      Html5QrcodeSupportedFormats.UPC_A,
    ];
    const config = {
      fps: 12,
      // kotak fokus 80% lebar layar, max 320px agar tajam
      qrbox: { width: Math.min(320, Math.floor(window.innerWidth*0.8)),
               height: Math.min(320, Math.floor(window.innerWidth*0.8)) },
      aspectRatio: 1.777,                // 16:9 sering lebih stabil
      formatsToSupport: formats,
      rememberLastUsedCamera: true,      // percepat buka berikutnya
    };

    const onSuccess = (decodedText/*, decodedResult*/) => {
      if (!decodedText) return;
      setMsg('Terbaca: ' + decodedText);
      finish(decodedText);
    };
    const onFailure = (_e)=>{}; // diamkan, biar terus scan

    try {
      const scanner = new Html5Qrcode("reader", { verbose: false });
      // Paksa environment dulu; kalau gagal jatuh ke fallback
      await scanner.start({ facingMode: { exact: "environment" } }, config, onSuccess, onFailure)
      .catch(async () => {
        // fallback: biarkan browser pilih kamera belakang yang ada
        await scanner.start({ facingMode: "environment" }, config, onSuccess, onFailure);
      });

      setMsg('Kamera aktif. Arahkan kode ke kotak putih.');
    } catch (e) {
      // fallback terakhir: tanpa constraint khusus, resolusi lebih rendah
      try {
        const scanner = new Html5Qrcode("reader", { verbose: false });
        await scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250, formatsToSupport: formats }, onSuccess, onFailure);
        setMsg('Kamera aktif (fallback).');
      } catch (e2) {
        errBox(e2);
      }
    }
  }

  window.addEventListener('load', () => {
    if (!window.Html5Qrcode) {
      setMsg('Library scanner belum termuat (cek koneksi/CDN).');
      return;
    }
    // Cek dukungan kamera
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      return errBox(new Error('getUserMedia tidak tersedia di perangkat ini'));
    }
    start();
  });
})();
</script>
</body>
</html>
